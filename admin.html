<!DOCTYPE html>
<html>
<head>
<title>Admin - Tableau de bord</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background-color: #f0f8ff;
    color: #333;
  }
  h1 {
    color: #e67e22;
  }
  table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    background-color: #ffffff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
  }
  th {
    background-color: #3498db;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  .meal-count {
    font-weight: bold;
    color: #2980b9;
  }
  .table-section {
    margin-top: 50px;
  }
  .export-button {
    padding: 10px 20px;
    background-color: #2ecc71;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1em;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  .export-button:hover {
    background-color: #27ae60;
  }
</style>
</head>
<body>

<h1>Tableau de bord Administrateur</h1>
<p>Suivi des repas par jour et par utilisateur.</p>

<div class="table-section">
  <h2>Récapitulatif par jour</h2>
  <button class="export-button" onclick="exportDailyToExcel()">Exporter le récapitulatif journalier</button>
  <table id="daily-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Midi (Total)</th>
        <th>Soir (Total)</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>
</div>

<div class="table-section">
  <h2>Récapitulatif par utilisateur</h2>
  <button class="export-button" onclick="exportUserToExcel()">Exporter le récapitulatif par utilisateur</button>
  <table id="user-table">
    <thead>
      <tr>
        <th>Email</th>
        <th>Mois</th>
        <th>Total repas</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    async function fetchAllMeals() {
        const response = await fetch('http://localhost:3000/api/get-all-meals');
        const data = await response.json();
        return data;
    }

    function formatDate(dateString) {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const date = new Date(dateString);
      return date.toLocaleDateString('fr-FR', options);
    }

    function sortDates(a, b) {
      return new Date(a) - new Date(b);
    }

    async function displayDailyDashboard() {
        const allMeals = await fetchAllMeals();
        const dailyTableBody = document.getElementById('daily-table').querySelector('tbody');
        dailyTableBody.innerHTML = '';

        const dailyTotals = {};
        allMeals.forEach(meal => {
            const date = meal.date;
            const mealType = meal.meal_type;
            const state = meal.state;

            if (!dailyTotals[date]) {
                dailyTotals[date] = { 'Midi': 0, 'Soir': 0 };
            }

            if (state === '1') {
                dailyTotals[date][mealType]++;
            }
        });

        const sortedDates = Object.keys(dailyTotals).sort(sortDates);

        sortedDates.forEach(date => {
            const row = document.createElement('tr');
            
            const dateCell = document.createElement('td');
            dateCell.textContent = formatDate(date);

            const midiCell = document.createElement('td');
            midiCell.textContent = dailyTotals[date]['Midi'];

            const soirCell = document.createElement('td');
            soirCell.textContent = dailyTotals[date]['Soir'];

            row.appendChild(dateCell);
            row.appendChild(midiCell);
            row.appendChild(soirCell);
            dailyTableBody.appendChild(row);
        });
    }

    async function displayUserDashboard() {
        const allMeals = await fetchAllMeals();
        const userTableBody = document.getElementById('user-table').querySelector('tbody');
        userTableBody.innerHTML = '';

        const userMonthlyTotals = {};
        allMeals.forEach(meal => {
            const user_email = meal.user_email;
            const mealDate = new Date(meal.date);
            const monthYear = `${mealDate.getFullYear()}-${mealDate.getMonth() + 1}`;

            if (!userMonthlyTotals[user_email]) {
                userMonthlyTotals[user_email] = {};
            }
            if (!userMonthlyTotals[user_email][monthYear]) {
                userMonthlyTotals[user_email][monthYear] = 0;
            }

            if (meal.state === '1') {
                userMonthlyTotals[user_email][monthYear]++;
            }
        });

        for (const email in userMonthlyTotals) {
            for (const monthYear in userMonthlyTotals[email]) {
                const row = document.createElement('tr');
                
                const emailCell = document.createElement('td');
                emailCell.textContent = email;

                const monthCell = document.createElement('td');
                const [year, month] = monthYear.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                monthCell.textContent = monthName;

                const totalMealsCell = document.createElement('td');
                totalMealsCell.textContent = userMonthlyTotals[email][monthYear];

                row.appendChild(emailCell);
                row.appendChild(monthCell);
                row.appendChild(totalMealsCell);
                userTableBody.appendChild(row);
            }
        }
    }
    
    function exportTableToExcel(tableID, filename = '') {
      const table = document.getElementById(tableID);
      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      XLSX.writeFile(wb, `${filename}.xlsx`);
    }

    function exportDailyToExcel() {
      exportTableToExcel('daily-table', 'recap_journalier');
    }

    function exportUserToExcel() {
      exportTableToExcel('user-table', 'recap_utilisateur');
    }

    displayDailyDashboard();
    displayUserDashboard();
</script>

</body>
</html>